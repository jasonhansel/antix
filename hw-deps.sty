

% Prevent clash with timesnewroman
\RequirePackage[full]{textcomp}

\RequirePackage{drac} % Easy 'active' characters


\RequirePackage[calc,english]{datetime2}


\RequirePackage{xstring} % String manipulation
\RequirePackage[nomessages]{fp} % Arithmetic
\RequirePackage{etoolbox} % Easier use of e-TeX extensions

\RequirePackage{xspace} % Macros that preserve spacing
\RequirePackage{newunicodechar}
\RequirePackage{pgfornament}
\RequirePackage{changepage}

% Math, symbols, etc.
\RequirePackage{amssymb} % Useful symbols
\RequirePackage[fleqn]{mathtools} % General math, including amsmath
\RequirePackage{cancel} % Cancellation
\RequirePackage{commath} % Math helpers
\RequirePackage{bm} % Bold math
\RequirePackage{nicefrac} % Annotate values with units
\RequirePackage[mathscr]{eucal} % Use \mathscr for fancy script text
\RequirePackage{sansmath}
\RequirePackage{scalerel}




% Typography


\usepackage{scrextend} % for blocquotes
\RequirePackage{lineno}
\RequirePackage{substitutefont}
\RequirePackage{environ}

% \RequirePackage[bgreek,greek,ibygreek, main=english, math=normal]{babel} % Multilingual tools
\RequirePackage[greek, main=english, math=normal]{babel} % Multilingual tools
% \babelprovide[hyphenrules=+]{bgreek}
% \babelprovide[hyphenrules=+]{ibygreek}

% \makeatletter
% \addto\extrasibygreek{\bbl@activate{!}}
% \addto\noextrasibygreek{\bbl@activate{!}}
% \makeatother

\RequirePackage[autostyle, english=american, parthreshold, strict=true, threshold=1]{csquotes} % Quotations


\ifearlychicago
  \RequirePackage[backend=biber,notes,hyperref=false,doi=false,eprint=false]{biblatex-chicago}  
\else
  \RequirePackage[backend=biber,style=mla,url=true,hyperref=false,noremoteinfo=false, language=english, block=ragged]{biblatex}
\fi


\makeatletter
%Remove \do\' from the list of reserved chars
\def\csq@resrvdchars{\do\9}
\makeatother

\RequirePackage{pbox}
\RequirePackage{mdframed}
\RequirePackage{tabularx}
\RequirePackage{tabularht}
\RequirePackage{ragged2e} % Non-justified text
\RequirePackage{setspace} % Better line spacing
\RequirePackage{soul} % Nice underlining
\RequirePackage[normalem]{ulem}
\RequirePackage{relsize} % Relative text sizing
\ifearlybeamer
\else
\RequirePackage[shortlabels]{enumitem} % Advanced lists
\fi
\RequirePackage[parfill]{parskip} % Paragraph indent/skip

% Page layout
\RequirePackage{multicol} % Multi-column text
\RequirePackage{parcolumns} % Parallel columns

% Boxes and frames
\RequirePackage{tcolorbox} % Colorful boxes
\RequirePackage[export]{adjustbox} % Transform text boxes
\RequirePackage{framed} % Better framed/shaded regions

% Graphics
\RequirePackage{tikz} % General diagrams and pictures
\RequirePackage{pgfpages} % TikZ page manipulation, can break hyperlinks
\RequirePackage{prooftrees} % Truth trees
\RequirePackage{forest} % Trees
\RequirePackage[all]{xy} % Diagrams (*breaks* when breqn enabled)
\RequirePackage{tikz-cd} % Diagrams (like xy-pic but better)

% Verbatim mode tools
\RequirePackage{alltt} % Like "verbatim" but with commands enabled
\RequirePackage{fancyvrb} % Enhanced "verbatim" modes
\RequirePackage{upquote} % Normal single/double quotes in 


% Tables
\RequirePackage[delarray]{tabu} % Advanced table-related features
\RequirePackage{multirow} % Easy multi-row cells
\RequirePackage[thinlines]{easytable} % Misc. table shortcuts
\RequirePackage{makecell} % Table cell customization
\usepackage[final]{pdfpages}

% Misc
\RequirePackage{syntax} % https://tex.stackexchange.com/questions/24886/
\RequirePackage{siunitx}


% Sans math
\makeatletter
\renewcommand{\sfMathSwitch}{\sfsl
  \make@math@version@font \textfont \fam \tf@size
}
\makeatother

% Plots
\usepackage{pgfplots}
\pgfplotsset{compat=1.3}
\usepgfplotslibrary{fillbetween}


% Grammar
\setlength{\grammarparsep}{20pt plus 1pt minus 1pt} % increase separation between rules
\setlength{\grammarindent}{6em} % increase separation between LHS/RHS 

% Bib;liography settings
\ifearlybeamer
\else
\renewcommand{\mkdatezeros}{\mkyearzeros}
\defbibheading{bibliography}[\refname]{\noindent\b{#1}}
\fi


\RequirePackage{antix-settings}





% Bibliography
\newcommand{\ci}{\autocite}
\newcommand{\cna}{\autocite*} % Omit author
\newcommand{\cnp}{\cite} % Omit parens
\newcommand{\cnap}{\cite*} % Omit parens and author



% A box with a horizontal rule at the bottom.
% Useful for study sheets.
\newcommand{\ibox}[1]{
\noindent\begin{minipage}{\linewidth}
    \vspace{7pt}
    #1
    \par
    \vspace{7pt}
    \hrule
\end{minipage}
}

% For "asterisk" option
\def\nostar{\catcode`\*=12}
\def\restar{\catcode`\*=13}
\def\noqmark{\catcode`?=12}
\def\reqmark{\catcode`?=13}
\newenvironment{fixstar}{\catcode`*=12}{}

\newcommand{\newactive}[2]{\catcode`#1=\active \scantokens{\DeclareRobustActChar{#1}{#2}} }
\makeatletter
\def\renewunicodechar#1#2{%
\@tempswafalse
\edef\nuc@tempa{\detokenize{#1}}%
\if\relax\nuc@tempa\relax
\nuc@emptyargerr
\else
\edef\@tempb{\expandafter\@car\nuc@tempa\@nil}%
\nuc@check
\if@tempswa
\@namedef{u8:\nuc@tempa}{#2}%
\fi
\fi
}
\makeatother

\RequirePackage{shortcuts}
\RequirePackage{shortcuts-text}
\RequirePackage{shortcuts-matrix}
\RequirePackage{shortcuts-unicode}

\newcolumntype{L}{>{$}l<{$}} % math-mode version of "l" column type
\newcolumntype{Q}{>{\displaystyle}l} % math-mode version of "l" column type
\newcolumntype{R}{>{$}r<{$}} % math-mode version of "l" column type



% Allow right-aligned cases in math mode
% http://tex.stackexchange.com/questions/27520/
\makeatletter
\newcases{rightalignedcases}{\:}{%
  \hfil$\m@th\displaystyle{##}$}{$\m@th\displaystyle{##}$\hfil}{\lbrace}{.}
\makeatother


% Parse options

\DeclareOptionX<late>{linesp}[1.2]{\AtEndOfClass{
    \setstretch{#1}
}}

\DeclareOptionX<late>{topaligntikz}{
  \tikzset{baseline={([yshift={-\ht\strutbox}]current bounding box.north)},outer sep=0pt,inner sep=0pt}
}

\newcommand{\vecsp}[2]{
  \ifthenelse{\equal{#1}{3}}{
      \vec{#2}
  }{
      \ifthenelse{\equal{#1}{4}}{
          \mathbf{#2}
      }{
        \ClassWarning{Invalid vector size}
      }
  }
}


% Enable by default
\presetkeys{hw.cls}{linesp}{}



\DeclareOptionX<late>{shortverb}{\AtEndOfClass{
    % Requires 'monomath' to be specified
    % \MakeShortVerb{\|}
    \DefineShortVerb{\|}
}}
\DeclareOptionX<late>{algorithms}{\AtEndOfClass{
  \usepackage[linesnumbered,commentsnumbered]{algorithm2e}
  \SetKw{KwLet}{let}
  \SetKw{KwWhere}{where}
  \SetKw{KwBreak}{break}
  \SetKw{Return}{return}
  \DontPrintSemicolon
  \let\gets\leftarrow
  \SetArgSty{textrm}
  \SetFuncSty{textrm}
  \SetFuncArgSty{textrm}
  \SetAlCapSty{textrm}
  \SetAlgoSkip{}
  \IncMargin{2em}
  \SetKwSty{boldcompact}
  \SetKwProg{Fn}{function}{ is}{end}
  \newcommand{\commentstyle}{\sffamily\relsize{-0.5}}
  \SetKwComment{Comment}{\fontfamily{phv}\selectfont\relsize{-0.5}// }{}

  \SetCommentSty{commentstyle}
  \SetKwInput{AlgoTitle}{Algorithm}
  \SetKwInput{AlgoTitleT}{Initialization Code}
  \SetAlgoInsideSkip{medskip}
}}

% Page margins
\ifearlybeamer
\else
\geometry{letterpaper,headheight=0pt,headsep=0in,margin=1in,ignoreheadfoot}
\DeclareOptionX<late>{margin}{
    \geometry{margin=#1in}
}
\newpagestyle{def}{
  \sethead{}{}{}
  \setfoot{}{}{}
}
\pagestyle{def}
\fi





% Header and footer
\DeclareOptionX<late>{smallheader}{
  \geometry{headheight=15pt,headsep=10pt,includehead,includefoot}
  \newpagestyle{custom}{
    \sethead{\mythetitle}{}{Jason Hansel}
    \setfoot{}{}{Page \thepage}
    \setheadrule{0.5pt}
    \setfootrule{0.5pt}
  }
  \newpagestyle{top}{
    \sethead{\mythetitle}{}{Jason Hansel}
    \setfoot{}{}{Page \thepage}
    \setheadrule{0.5pt}
    \setfootrule{0.5pt}
  }
  \pagestyle{custom}
}

\DeclareOptionX<late>{simpleheader}{
  % \geometry{headheight=15pt,headsep=10pt,includehead,includefoot}
  \newpagestyle{custom}{
    \sethead{}{}{}
    \setfoot{}{}{Page \thepage}
    % \setheadrule{0}
    % \setfootrule{0}
  }
  \pagestyle{custom}
}


\setlength{\parindent}{0em}
\setlength{\arraycolsep}{2pt}

\DeclareOptionX<late>{ragged}{
    \setlength{\RaggedRightParindent}{\parindent}
    \raggedright % Actually, ragged2e isn't very good
}

\DeclareOptionX<late>{parindent}{
    \setlength{\parindent}{3em}
    \setlength{\parskip}{0em}
}

\DeclareOptionX<late>{nohyphen}{
    %  May need to set "emergencystretch" to avoid line-break issues.
  % May be better to use 'pretolerance' instead.
    \hyphenpenalty=10000
    \exhyphenpenalty=10000
}

\DeclareOptionX<late>{noskip}{
    \setlength{\parindent}{0em}
    \setlength{\parskip}{0em}
}




\DeclareOptionX<late>{resume}{\AtEndOfClass{
  % Typography
\usepackage[scaled=1.0]{inconsolata}
\AtBeginDocument{\figureversion{tab}}

% Fix conversion to text
\input glyphtounicode
\pdfmapline{+dummy-space <dummy-space.pfb}
\pdfglyphtounicode{space}{0020}
\pdfgentounicode=1
\pdfadjustspacing=0
\pdfadjustinterwordglue=0
\pdfinterwordspaceon

% Headings
\titleformat{\chapter}[runin]{}{}{0pt}{\Huge}
\titleformat{\section}[block]{}{}{0pt}{\\[-\baselineskip]\Large\textbf}
\titleformat{\subsection}[block]{}{}{0pt}{\\[-\baselineskip]} % So parsers see the newline
\titlespacing{\section}{0pt}{0pt plus 3fil}{0pt plus 3fil}
\titlespacing{\subsection}{0pt}{0pt plus 3fil}{0pt}

% Spacing
\geometry{noheadfoot}
\setlist{partopsep=0pt,topsep=0pt,itemsep=0pt,parsep=0pt,leftmargin=0pt,rightmargin=0pt}
\setlength{\parfillskip}{0pt plus 1fil} % Fix end-of-line spacing
\AtBeginDocument{\setlength{\baselineskip}{14pt plus 2fil}}
\flushbottom
}}
\DeclareOptionX<late>{coverletter}{\AtEndOfClass{
% Typography
\usepackage[scaled=1.0]{inconsolata}
\AtBeginDocument{\figureversion{tab}}

% Fix conversion to text
\input glyphtounicode
\pdfmapline{+dummy-space <dummy-space.pfb}
\pdfglyphtounicode{space}{0020}
\pdfgentounicode=1
\pdfadjustspacing=0
\pdfadjustinterwordglue=0
\pdfinterwordspaceon

% Headings
\titleformat{\chapter}[runin]{}{}{0pt}{\Huge}
\titleformat{\section}[block]{}{}{0pt}{\\[-\baselineskip]\Large\textbf}
\titleformat{\subsection}[block]{}{}{0pt}{\\[-\baselineskip]} % So parsers see the newline
\titlespacing{\section}{0pt}{0pt plus 3fil}{0pt plus 3fil}
\titlespacing{\subsection}{0pt}{0pt plus 3fil}{0pt}

% Spacing
\geometry{noheadfoot}
\setlist{partopsep=0pt,topsep=0pt,itemsep=0pt,parsep=0pt,leftmargin=0pt,rightmargin=0pt}
\setlength{\parfillskip}{0pt} % Fix end-of-line spacing
\AtBeginDocument{\setlength{\baselineskip}{14pt plus 2fil}}
\flushbottom


\setlength{\parfillskip}{0pt plus 1fil} % Fix end-f-line spacing
\addtolength{\baselineskip}{0pt plus 1fil}
\setlength{\parindent}{3em}
\setlength{\parskip}{0.5\baselineskip}
}}

\DeclareOptionX<late>{fontface}{\AtEndOfClass{
    \IfEqCase{#1}{
        % Avoid always including "newtxtext" since it introduces log-parsing errors
        {times}{ \RequirePackage{newtxtext}
    \renewcommand{\bfdefault}{b} % Actually this fixes log issues
    \renewcommand{\b}{\textbf}
    \renewcommand{\i}{\textit}
    % \substitutefont{BCG}{\rmdefault}{cmr}

     }
        {minion}{

          \usepackage[]{microtype}
          \RequirePackage[onlytext,normalsize,lf]{MinionPro}
          \renewcommand{\bfdefault}{b}
         }
    }
}}

\makeatletter
\newif\if@monomath
\@monomathfalse
\DeclareOptionX<late>{monomath}{\@monomathtrue}

\newif\if@incons
\@inconsfalse
\DeclareOptionX<late>{incons}{\@inconstrue}

\newif\if@nobreqn
\@nobreqnfalse
\DeclareOptionX<late>{nobreqn}{\@nobreqntrue}

\newif\if@forceams
\@forceamsfalse
\DeclareOptionX<late>{forceams}{\@forceamstrue}
\makeatother




\DeclareOptionX<late>{lowdisplayskip}{\AtEndOfClass{
    \AtBeginDocument{
        \setlength{\abovedisplayskip}{2pt}
        \setlength{\belowdisplayskip}{2pt}
        \setlength{\abovedisplayshortskip}{2pt}
        \setlength{\belowdisplayshortskip}{2pt} 
        \global\tabulinesep=2pt
    }
}}

\DeclareOptionX<late>{meddisplayskip}{\AtEndOfClass{
    \AtBeginDocument{
        \setlength{\abovedisplayskip}{0.3\baselineskip}
        \setlength{\belowdisplayskip}{0.3\baselineskip}
        \setlength{\abovedisplayshortskip}{0.3\baselineskip}
        \setlength{\belowdisplayshortskip}{0.3\baselineskip}
        \setlength{\jot}{0.3\baselineskip}
        \renewcommand*{\arraystretch}{0.9}
    }
}}



\DeclareOptionX<late>{colsep}{\AtEndOfClass{
  \setlength{\columnseprule}{0.2pt}
}}


\DeclareOptionX<late>{micro}{ % For review sheets
  \setlength{\columnsep}{5pt}
\setlength{\columnseprule}{0.5pt}
\setlength{\parskip}{0pt}
\setlength{\mathindent}{5pt}
\setlist[itemize]{noitemsep,leftmargin=0.7em,label=\textbullet,labelsep=0.2em}
\setlist[itemize,2]{noitemsep,leftmargin=0.7em,label=\textbullet,labelsep=0.2em}
\setlist[enumerate]{noitemsep,leftmargin=1em,labelsep=0.2em}
\setlist[enumerate,2]{a),leftmargin=1.2em}
\renewcommand\bfdefault{b}
% \linepenalty=10000
\hfuzz 100pt
\emergencystretch 0pt
\setlength{\abovedisplayskip}{0pt}
  \setlength{\belowdisplayskip}{0pt}
  \setlength{\abovedisplayshortskip}{0pt}
  \setlength{\belowdisplayshortskip}{0pt} 
}

\makeatletter
\DeclareOptionX<late>{pageborder}{
  % \usepackage{showframe}

% \def\Gm@hruled{\vspace{1cm}}
\def\Gm@hrule{\hrule width \textwidth height 0.5pt}
\def\Gm@vrule{\vrule width 0.5pt height\textheight depth\z@}
% \def\Gm@hrule{\moveleft.5\columnsep\vbox{\hrule height 0.5pt depth\z@ width\textwidth}}
\renewcommand*{\Gm@vrules@mpi}{%
\hb@xt@\textwidth{\hspace{-0.5\columnsep}\Gm@vrule\hskip\textwidth\hspace{4.5pt}\Gm@vrule}}

\geometry{showframe}
}
\makeatother

\makeatletter
\define@boolkey{late}[my@]{gravity}[false]{}

\makeatother

\DeclareOption{beamer}

% \ProcessOptionsX
\ProcessOptionsX*<late>


\makeatletter
\ifmy@gravity
  \renewcommand{\C}[2]{{#2}^{#1}}
  \newcommand{\Cp}[2]{{#2}^{\prime #1}}
  \newcommand{\Ch}[2]{{#2}^{\hat #1}}

  \newcommand{\E}[1]{{\mathbf{e}}_{{#1}}}
  \newcommand{\Ep}[1]{{\mathbf{e}}_{\prime {#1}}}
  \newcommand{\Eh}[1]{{\mathbf{e}}_{\hat {#1}}}

  \newcommand{\G}[1]{g_{#1}}
  \newcommand{\Gp}[1]{g'_{#1}}

  \newcommand{\TMR}{1 - \frac{2M}{R}}
  \newcommand{\oTMR}{\of{1 - \frac{2M}{R}}}
\fi
\makeatother








\renewcommand\cellalign{tl}
\ifearlybeamer
\else
\setlength{\mathindent}{0pt}
\AtEndOfClass{ % Configure csquotes; csquotes loaded late
  
    \MakeOuterQuote{"}
  % \MakeAutoQuote{`}{'}
  \tikzset{every picture/.prefix code=\DisableQuotes} % Fix quotes in TikZ
  
}
\fi


\newlength{\msize}
\setlength{\msize}{30pt}
\newcommand{\mathitem}[1]{
    \parbox[t]{\linewidth}{
        \vspace{\msize}
        #1
    }
}






% http://tex.stackexchange.com/questions/1273/loading-a-package-conditionally
\makeatletter
\if@incons
  \usepackage[scaled=0.95]{inconsolata}
\fi

\if@monomath
    \renewcommand*{\rmdefault}{\ttdefault}
    \usepackage[defaultimath]{mathastext}
    \renewcommand*{\rmdefault}{lmr}
  \thinmuskip=1mu
  \medmuskip=1mu
  \thickmuskip=2mu
\else
    % Breqn conflicts with mathastext
  \if@nobreqn
  \else
     \usepackage{breqn}
   % fix a weird bug with the '+' sign wrapping in breqn - not sure why 
   % this is ever necessary...
   % \DeclareFlexSymbol{+}{Bin}{OT1}{2B}
     % \setkeys{breqn}{compact}
   % \setlength{\eq@linewidth}{0pt}
\fi\fi



% must be after 'breqn'
\if@forceams
% force amsmath, and replace '$' and '$$' with LaTeX equivalents.
% May break tikz.
\RequirePackage[all,error]{onlyamsmath}
\setlength{\mathindent}{3em}
\renewcommand{\dspcomplain}[1]{
\ifmmode
    \expandafter\]
\else
    \expandafter\[
\fi
}  
\fi


\makeatother

% \let\originalleft\left
% \let\originalright\right
% \renewcommand{\left}{\mathopen{}\mathclose\bgroup\originalleft}
% \renewcommand{\right}{\aftergroup\egroup\originalright}


% Redo after breqn
\renewcommand{\del}[1]{\left(#1\right)}
\renewcommand{\ne}{\ensuremath{\neq}}






\endinput
